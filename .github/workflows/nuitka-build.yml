name: Nuitka å®šæ—¶æž„å»º

on:
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹è‡ªåŠ¨æž„å»º (UTCæ—¶é—´)
    - cron: '0 3 * * 0'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      python-version:
        description: 'Pythonç‰ˆæœ¬'
        required: false
        default: '3.11'
        type: choice
        options:
          - '3.8'
          - '3.9'
          - '3.10'
          - '3.11'

jobs:
  build-windows:
    name: æž„å»º Windows ç‰ˆæœ¬
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ github.event.inputs.python-version && fromJSON(format('["{0}"]', github.event.inputs.python-version)) || fromJSON('["3.11"]') }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install nuitka ordered-set zstandard

    - name: æ£€æŸ¥é¡¹ç›®ç»“æž„
      run: |
        echo "=== é¡¹ç›®æ–‡ä»¶ç»“æž„ ==="
        dir
        echo ""
        echo "=== srcç›®å½•å†…å®¹ ==="
        dir src
        echo ""
        echo "=== æ£€æŸ¥å›¾æ ‡æ–‡ä»¶ ==="
        if (Test-Path "src/img/logo.ico") {
          echo "æ‰¾åˆ°å›¾æ ‡æ–‡ä»¶: src/img/logo.ico"
        } else {
          echo "è­¦å‘Š: æœªæ‰¾åˆ°å›¾æ ‡æ–‡ä»¶"
        }

    - name: ä½¿ç”¨ Nuitka ç¼–è¯‘
      run: |
        echo "å¼€å§‹ä½¿ç”¨ Nuitka ç¼–è¯‘ PhotosViewer..."

        # åˆ›å»ºè¾“å‡ºç›®å½•
        New-Item -ItemType Directory -Force -Path "dist"

        # Nuitka ç¼–è¯‘å‘½ä»¤
        python -m nuitka `
          --standalone `
          --onefile `
          --enable-plugin=tk-inter `
          --windows-console-mode=disable `
          --windows-icon-from-ico=src/img/logo.ico `
          --include-data-dir=src=src `
          --output-dir=dist `
          --output-filename=PhotosViewer.exe `
          --company-name="MitaHill" `
          --product-name="PhotosViewer" `
          --file-version=2.9.0.0 `
          --product-version=2.9 `
          --file-description="å›¾ç‰‡æŸ¥çœ‹å™¨ - Photo Viewer" `
          --copyright="Â© 2025 Mita Hill. All rights reserved." `
          --follow-imports `
          --assume-yes-for-downloads `
          app.py

        echo "ç¼–è¯‘å®Œæˆï¼"

    - name: éªŒè¯æž„å»ºäº§ç‰©
      run: |
        echo "=== æ£€æŸ¥æž„å»ºäº§ç‰© ==="
        if (Test-Path "dist/PhotosViewer.exe") {
          $fileInfo = Get-Item "dist/PhotosViewer.exe"
          echo "âœ“ æž„å»ºæˆåŠŸï¼"
          echo "æ–‡ä»¶å¤§å°: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
          echo "ä¿®æ”¹æ—¶é—´: $($fileInfo.LastWriteTime)"
        } else {
          echo "âœ— æž„å»ºå¤±è´¥ï¼šæœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          exit 1
        }

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        echo "åˆ›å»ºå‘å¸ƒåŒ…..."
        New-Item -ItemType Directory -Force -Path "release"

        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        Copy-Item "dist/PhotosViewer.exe" "release/"

        # å¤åˆ¶å¿…è¦æ–‡ä»¶
        if (Test-Path "README.md") { Copy-Item "README.md" "release/" }
        if (Test-Path "LICENSE") { Copy-Item "LICENSE" "release/" }
        if (Test-Path "CHANGELOG.md") { Copy-Item "CHANGELOG.md" "release/" }

        # åˆ›å»ºZIPåŽ‹ç¼©åŒ…
        $version = "2.9"
        $date = Get-Date -Format "yyyyMMdd"
        $archiveName = "PhotosViewer-Windows-v$version-nuitka-$date.zip"

        Compress-Archive -Path "release/*" -DestinationPath $archiveName -Force
        echo "å·²åˆ›å»ºåŽ‹ç¼©åŒ…: $archiveName"

    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: PhotosViewer-Windows-Nuitka-Python${{ matrix.python-version }}
        path: PhotosViewer-Windows-*.zip
        retention-days: 30

  create-summary:
    name: åˆ›å»ºæž„å»ºæ‘˜è¦
    runs-on: ubuntu-latest
    needs: [build-windows]
    if: always()

    steps:
    - name: ç”Ÿæˆæž„å»ºæŠ¥å‘Š
      run: |
        echo "# ðŸ“¦ Nuitka æž„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æž„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Python ç‰ˆæœ¬**: ${{ matrix.python-version || '3.11' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## æž„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Windows æž„å»ºçŠ¶æ€
        if [ "${{ needs.build-windows.result }}" == "success" ]; then
          echo "âœ… Windows æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Windows æž„å»ºå¤±è´¥: ${{ needs.build-windows.result }}" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æž„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° GitHub Actions Artifactsï¼Œä¿ç•™æœŸä¸º 30 å¤©ã€‚" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è®¿é—® [Actions](https://github.com/${{ github.repository }}/actions) é¡µé¢ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY

    - name: ä¸‹è½½æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      if: success()
      with:
        path: all-artifacts

    - name: åˆ—å‡ºæž„å»ºäº§ç‰©
      if: success()
      run: |
        echo "=== æž„å»ºäº§ç‰©åˆ—è¡¨ ==="
        ls -lR all-artifacts/
